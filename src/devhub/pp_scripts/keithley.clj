(ns devhub.pp-scripts.keithley
  ^{:author "Thomas Bock <wactbprot@gmail.com>"
    :doc "Post processing for Keithley DMM."}
  (:require [clojure.string :as string]
            [devhub.pp-utils :as ppu]
            [devhub.utils :as u]))


(def v ["+1.616283E-12A,+1.509776E+06,+2.000000E+00" "+1.634993E-12A,+1.509777E+06,+2.000000E+00" "+1.755563E-12A,+1.509778E+06,+2.000000E+00" "+1.778430E-12A,+1.509779E+06,+2.000000E+00" "+1.776351E-12A,+1.509780E+06,+2.000000E+00" "+1.842872E-12A,+1.509780E+06,+2.000000E+00" "+1.828321E-12A,+1.509781E+06,+2.000000E+00" "+1.874054E-12A,+1.509782E+06,+2.000000E+00" "+1.894842E-12A,+1.509783E+06,+2.000000E+00" "+1.882369E-12A,+1.509784E+06,+2.000000E+00" "+1.809612E-12A,+1.509785E+06,+2.000000E+00" "+1.849109E-12A,+1.509786E+06,+2.000000E+00" "+1.736854E-12A,+1.509787E+06,+2.000000E+00" "+1.670332E-12A,+1.509788E+06,+2.000000E+00" "+1.707751E-12A,+1.509788E+06,+2.000000E+00" "+1.630835E-12A,+1.509789E+06,+2.000000E+00" "+1.589259E-12A,+1.509790E+06,+2.000000E+00" "+1.578865E-12A,+1.509791E+06,+2.000000E+00" "+1.605890E-12A,+1.509792E+06,+2.000000E+00" "+1.593417E-12A,+1.509793E+06,+2.000000E+00" "+1.705672E-12A,+1.509794E+06,+2.000000E+00" "+1.753484E-12A,+1.509795E+06,+2.000000E+00" "+1.757641E-12A,+1.509795E+06,+2.000000E+00" "+1.855345E-12A,+1.509796E+06,+2.000000E+00" "+1.826242E-12A,+1.509797E+06,+2.000000E+00" "+1.882369E-12A,+1.509798E+06,+2.000000E+00" "+1.986309E-12A,+1.509799E+06,+2.000000E+00" "+1.923945E-12A,+1.509800E+06,+2.000000E+00" "+1.888606E-12A,+1.509801E+06,+2.000000E+00" "+1.926024E-12A,+1.509802E+06,+2.000000E+00" "+1.936418E-12A,+1.509803E+06,+2.000000E+00" "+1.861581E-12A,+1.509803E+06,+2.000000E+00" "+1.815848E-12A,+1.509804E+06,+2.000000E+00" "+1.815848E-12A,+1.509805E+06,+2.000000E+00" "+1.876133E-12A,+1.509806E+06,+2.000000E+00" "+1.855345E-12A,+1.509807E+06,+2.000000E+00" "+1.834557E-12A,+1.509808E+06,+2.000000E+00" "+1.934339E-12A,+1.509809E+06,+2.000000E+00" "+1.921866E-12A,+1.509810E+06,+2.000000E+00" "+1.990467E-12A,+1.509810E+06,+2.000000E+00" "+2.050752E-12A,+1.509811E+06,+2.000000E+00" "+2.067382E-12A,+1.509812E+06,+2.000000E+00" "+2.160928E-12A,+1.509813E+06,+2.000000E+00" "+2.077776E-12A,+1.509814E+06,+2.000000E+00" "+2.015412E-12A,+1.509815E+06,+2.000000E+00" "+2.029964E-12A,+1.509816E+06,+2.000000E+00" "+1.938497E-12A,+1.509817E+06,+2.000000E+00" "+1.865739E-12A,+1.509818E+06,+2.000000E+00" "+1.842872E-12A,+1.509818E+06,+2.000000E+00" "+1.736853E-12A,+1.509819E+06,+2.000000E+00" "+1.709829E-12A,+1.509820E+06,+2.000000E+00" "+1.686962E-12A,+1.509821E+06,+2.000000E+00" "+1.620441E-12A,+1.509822E+06,+2.000000E+00" "+1.614204E-12A,+1.509823E+06,+2.000000E+00" "+1.574707E-12A,+1.509824E+06,+2.000000E+00" "+1.512343E-12A,+1.509825E+06,+2.000000E+00" "+1.580944E-12A,+1.509826E+06,+2.000000E+00" "+1.649544E-12A,+1.509826E+06,+2.000000E+00" "+1.709829E-12A,+1.509827E+06,+2.000000E+00" "+1.722302E-12A,+1.509828E+06,+2.000000E+00"])

(defn extract [s]
  (let [r #"[+-]?([0-9]{1}\.[0-9]{6}[E][-+][0-9]{2})A"]
    (second (re-matches r (-> s
                              (string/split #",")
                              first)))))


(defn read-6485-coll-current
  "Read the collector current of the lab gauge. With slow filter at
  least the first 10 readings should be droped."
  [{{t :Token u :Unit n :Skip} :PostScriptInput x :_x :as task}]
  (merge task {:Result [(ppu/vl-result t (drop n (mapv (comp u/number extract) x)) u)]}))
  
